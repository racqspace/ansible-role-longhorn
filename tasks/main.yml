---
- name: Install Longhorn dependencies
  ansible.builtin.apt:
    name:
      - open-iscsi
      - curl
      - util-linux
      - grep
      - mawk
      - libblkid1
      - python3-pip
    state: present
    update_cache: true
    cache_valid_time: "{{ longhorn_cache_valid_time }}"
  tags:
    - longhorn
    - longhorn.dependencies

- name: Install ansible dependencies
  ansible.builtin.pip:
    name:
      - kubernetes
  tags:
    - longhorn
    - longhorn.dependencies

- name: Install Longhorn
  block:
    - name: Create temporary file for longhorn manifest
      ansible.builtin.tempfile:
        state: file
        suffix: longhorn
      register: longhorn_manifest_tempfile
      tags:
        - longhorn
        - longhorn.manifest
        - longhorn.manifest.tempdir

    - name: Download longhorn manifest
      ansible.builtin.get_url:
        url: "https://raw.githubusercontent.com/longhorn/longhorn/{{ longhorn_release }}/deploy/longhorn.yaml"   # yamllint disable-line rule:line-length
        dest: "{{ longhorn_manifest_tempfile.path }}"
        mode: '0664'
      tags:
        - longhorn
        - longhorn.manifest
        - longhorn.manifest.download

    - name: Install Longhorn
      kubernetes.core.k8s:
        state: present
        src: "{{ longhorn_manifest_tempfile.path }}"
      tags:
        - longhorn
        - longhorn.manifest
        - longhorn.manifest.install
  run_once: true

- name: Add Longhorn storageclass
  kubernetes.core.k8s:
    state: present
    template: longhorn-storageclass.yml.j2
  run_once: true
  tags:
    - longhorn
    - longhorn.storageclass

- name: Add Longhorn Ingress
  kubernetes.core.k8s:
    state: present
    template: longhorn-ingress.yml.j2
  run_once: true
  when:
    - longhorn_ingress | bool
  tags:
    - longhorn
    - longhorn.ingress
...
